# 百度网盘文件同步工具 - 使用说明

> 本工具面向 Python 初学者，所有步骤都有详细说明

## 📋 目录

1. [准备工作](#准备工作)
2. [环境设置](#环境设置)
3. [获取 Cookie](#获取-cookie)
4. [使用步骤](#使用步骤)
5. [常见问题](#常见问题)

---

## 准备工作

### 1. 安装 Python

**检查是否已安装 Python：**

- **Windows**: 打开命令提示符（CMD），输入 `python --version`
- **macOS/Linux**: 打开终端，输入 `python3 --version`

如果显示版本号（如 `Python 3.8.5`），说明已安装。如果没有，请访问 [Python 官网](https://www.python.org/downloads/) 下载安装。

**要求：Python 3.7 或更高版本**

### 2. 安装 BaiduPCS-Go

BaiduPCS-Go 是一个命令行工具，用于操作百度网盘。

**自动安装（推荐）：**

运行环境设置脚本时，会自动检查并尝试安装 BaiduPCS-Go：

- **macOS**: 如果已安装 Homebrew，会自动使用 `brew install baidupcs-go` 安装
- **Windows**: 如果已安装 Chocolatey，会自动使用 `choco install baidupcs-go` 安装
- **Linux**: 提供安装指导

**手动安装：**

如果自动安装失败，可以手动安装：

**macOS:**
```bash
brew install baidupcs-go
```

**Windows:**
```bash
# 使用 Chocolatey
choco install baidupcs-go

# 或从 GitHub 下载
# https://github.com/qjfoidnh/BaiduPCS-Go/releases
```

**Linux:**
```bash
# Arch Linux
sudo pacman -S baidupcs-go

# 或从 GitHub 下载
# https://github.com/qjfoidnh/BaiduPCS-Go/releases
```

**验证安装：**

打开终端/命令提示符，输入：
```bash
BaiduPCS-Go --version
```

如果显示版本信息，说明安装成功。

---

## 环境设置

### 方法一：使用 Python 脚本（推荐）

**Windows:**
```bash
python setup_env.py
```

**macOS/Linux:**
```bash
python3 setup_env.py
```

**说明：**
- 脚本会自动检查并尝试安装 BaiduPCS-Go（如果未安装）
- macOS 用户如果已安装 Homebrew，会自动使用 brew 安装
- Windows 用户如果已安装 Chocolatey，会自动使用 choco 安装

### 方法二：使用 Shell 脚本

**macOS/Linux:**
```bash
bash setup_env.sh
```

**Windows:**
```bash
setup_env.bat
```

### 激活虚拟环境

设置完成后，需要激活虚拟环境才能使用：

**Windows:**
```bash
venv\Scripts\activate.bat
```

**macOS/Linux:**
```bash
source venv/bin/activate
```

激活成功后，命令行前面会显示 `(venv)`。

**退出虚拟环境：**
```bash
deactivate
```

---

## 获取 Cookie

### 什么是 Cookie？

Cookie 是浏览器保存的登录信息，用于保持登录状态。

### 如何获取 Cookie？

1. **打开百度网盘网页版**
   - 访问 https://pan.baidu.com
   - 登录你的账号

2. **打开浏览器开发者工具**
   - **Chrome/Edge**: 按 `F12` 或右键 → 检查
   - **Firefox**: 按 `F12` 或右键 → 检查元素
   - **Safari**: 需要先启用开发者菜单

3. **切换到 Network（网络）标签**
   - 在开发者工具中找到 "Network" 或 "网络" 标签

4. **刷新页面或进行任意操作**
   - 刷新页面（F5）
   - 在 Network 标签中会看到很多请求

5. **找到任意一个请求，查看 Headers**
   - 点击任意一个请求
   - 找到 "Request Headers" 或 "请求头"
   - 找到 `Cookie:` 这一行，复制后面的内容

6. **或者使用 curl 命令**
   - 在 Network 标签中，右键点击任意请求
   - 选择 "Copy" → "Copy as cURL"
   - 将内容保存到 `curl.txt` 文件中

### 准备 curl.txt 文件

将获取到的 curl 命令保存到项目目录下的 `curl.txt` 文件中。

**示例 curl.txt 内容：**
```
curl 'https://d.pcs.baidu.com/rest/2.0/pcs/file?method=locateupload' \
  -H 'accept: application/json' \
  -b 'PSTM=1739107486; BDUSS=...; STOKEN=...; ...'
```

---

## 使用步骤

### 第一步：登录（自动解析 Cookie）

**激活虚拟环境后，直接运行登录脚本：**

```bash
python login.py
```

**说明：**
- 脚本会自动查找当前目录下的 `curl.txt` 文件
- 如果找到 `curl.txt`，会自动解析 cookie 并登录
- 如果找到 `cookies.json`，会直接使用（跳过解析步骤）
- 也可以指定文件：`python login.py curl.txt` 或 `python login.py cookies.json`
- 如果已登录，会询问是否重新登录

**输出示例：**
```
找到 BaiduPCS-Go: BaiduPCS-Go

检查当前登录状态...
自动检测到 curl.txt 文件，开始解析...

正在解析文件: curl.txt
成功解析 20 个 cookie 字段
解析结果已保存到: cookies.json

执行登录命令: BaiduPCS-Go login -cookies="..." (cookie 字符串已隐藏)
正在登录...

✅ 登录成功！

验证登录状态...
```

**说明：**
- 脚本会优先使用完整的 cookie 字符串登录（更安全可靠）
- 如果完整 cookie 字符串不可用，会自动回退到使用 BDUSS + STOKEN 登录
- 解析结果会自动保存到 `cookies.json`，下次可以直接使用

### 可选：单独解析 Cookie

如果需要单独解析 cookie（不登录），可以使用：

```bash
python parse_cookie.py curl.txt
```

这会解析 cookie 并保存到 `cookies.json`，但不会执行登录。

### 登出功能

如果需要登出当前账号，可以使用：

```bash
python logout.py
```

**说明：**
- 脚本会检查当前登录状态
- 如果已登录，会询问确认后登出
- 使用 `--force` 参数可以跳过确认直接登出：`python logout.py --force`

**输出示例：**
```
找到 BaiduPCS-Go: BaiduPCS-Go

检查当前登录状态...
当前登录状态:
当前帐号 uid: 532273200, 用户名: xuwenda123756...

确认要登出吗？(y/N): y

执行登出...

✅ 登出成功！

验证登出状态...
✅ 确认已登出
```

### 第二步：上传文件

#### 方式一：使用参数（推荐）

**上传单个文件：**

```bash
python upload.py --local-file /本地/文件/路径.txt --remote-dir /我的文件/备份
```

**上传整个文件夹：**

```bash
python upload.py --local-file /本地/文件夹/路径 --remote-dir /我的文件/备份
```

**参数说明：**
- `--local-file` 或 `--local-path`：本地文件或文件夹路径（可以是文件或文件夹）
- `--remote-dir` 或 `--remote-path`：远端目标目录（百度网盘中的路径）

**示例：**
```bash
# Windows - 上传文件
python upload.py --local-file C:\Users\用户名\Documents\test.txt --remote-dir /我的文件/备份

# Windows - 上传文件夹
python upload.py --local-file C:\Users\用户名\Documents\我的文档 --remote-dir /我的文件/备份

# macOS/Linux - 上传文件
python upload.py --local-file /Users/用户名/Documents/test.txt --remote-dir /我的文件/备份

# macOS/Linux - 上传文件夹
python upload.py --local-file /Users/用户名/Documents/我的文档 --remote-dir /我的文件/备份
```

#### 方式二：使用位置参数（向后兼容）

**上传单个文件：**

```bash
python upload.py /本地/文件/路径.txt /我的文件/备份
```

**上传整个文件夹：**

```bash
python upload.py /本地/文件夹/路径 /我的文件/备份
```

**参数说明：**
- 第一个参数：本地文件或文件夹路径
- 第二个参数：远端目标目录（百度网盘中的路径）

**示例：**
```bash
# Windows
python upload.py C:\Users\用户名\Documents\test.txt /我的文件/备份

# macOS/Linux
python upload.py /Users/用户名/Documents/test.txt /我的文件/备份
```

**说明：**
- 推荐使用 `--local-file` 和 `--remote-dir` 参数，更清晰明确
- `--local-file` 可以接受文件或文件夹路径，脚本会自动判断
- 位置参数方式仍然支持，用于向后兼容
- 上传文件夹时会递归上传所有文件和子文件夹
- 保持原有的目录结构

**断点续传功能：**

如果上传任务很多，中间某个任务失败了，可以使用 `--resume` 参数从失败的地方继续：

```bash
# 第一次上传（如果中途失败）
python upload.py --local-file /本地/文件夹 --remote-dir /我的文件/备份

# 第二次运行（从失败的地方继续）
python upload.py --local-file /本地/文件夹 --remote-dir /我的文件/备份 --resume
```

**断点续传说明：**
- 使用 `--resume` 参数会跳过已成功上传的文件，只执行失败或未执行的任务
- 任务状态保存在 `upload_tasks_status/` 文件夹中，文件名格式为：`日期时间_本地名称_远端名称_哈希.json`
  - 例如：`20260118_143022_upload_log_20260118_TestUpload_abc12345.json`
  - 这样命名便于按时间排序和查找对应的任务状态
- 如果想重新开始，使用 `--clear-status` 参数清除状态文件

**示例：**
```bash
# 清除状态，重新开始
python upload.py --local-file /本地/文件夹 --remote-dir /我的文件/备份 --clear-status
```

**上传后，本地目录结构会完整保留在远端：**

```
本地: /Documents/我的文档/2024/01/报告.pdf
远端: /我的文件/备份/我的文档/2024/01/报告.pdf
```

### 查看上传记录

上传记录保存在 `upload_logs` 目录下，按日期命名：

```
upload_logs/
  ├── upload_log_20240120.json
  ├── upload_log_20240121.json
  └── ...
```

**记录文件格式（JSON）：**
```json
[
  {
    "upload_time": "2024-01-20 15:30:45",
    "local_path": "/Users/用户名/Documents/test.txt",
    "remote_path": "/我的文件/备份/test.txt",
    "file_size": 1024,
    "status": "success"
  }
]
```

---

## 常见问题

### 1. 提示 "未找到 BaiduPCS-Go 命令"

**原因：** BaiduPCS-Go 未安装或未添加到 PATH

**解决方法：**
1. 确认已下载并解压 BaiduPCS-Go
2. 将可执行文件路径添加到系统 PATH
3. 或者将 BaiduPCS-Go 可执行文件放在项目目录下

### 2. 登录失败

**可能原因：**
- Cookie 已过期（需要重新获取）
- Cookie 格式不正确
- 网络连接问题

**解决方法：**
1. 重新获取 Cookie（参考 [获取 Cookie](#获取-cookie) 部分）
2. 重新运行 `parse_cookie.py` 和 `login.py`
3. 检查网络连接

### 3. 提示 "远端目录不存在"

**原因：** 指定的远端目录在百度网盘中不存在

**解决方法：**
1. 先在百度网盘网页版创建该目录
2. 确认路径正确（注意使用 `/` 作为路径分隔符）
3. 路径示例：`/我的文件/备份`（不是 `我的文件\备份`）

### 4. 上传失败

**可能原因：**
- 网络不稳定
- 文件权限问题
- 磁盘空间不足

**解决方法：**
1. 检查网络连接
2. 检查文件是否有读取权限
3. 检查百度网盘剩余空间
4. 查看错误信息，根据提示处理

### 5. 虚拟环境相关问题

**问题：** 提示找不到模块或命令

**解决方法：**
1. 确认已激活虚拟环境（命令行前有 `(venv)`）
2. 如果未激活，运行：
   - Windows: `venv\Scripts\activate.bat`
   - macOS/Linux: `source venv/bin/activate`

### 6. Python 版本问题

**问题：** 提示 Python 版本过低

**解决方法：**
1. 安装 Python 3.7 或更高版本
2. 使用 `python3` 命令而不是 `python`（某些系统）

### 7. 路径问题

**Windows 路径：**
- 使用反斜杠 `\` 或正斜杠 `/` 都可以
- 示例：`C:\Users\用户名\Documents` 或 `C:/Users/用户名/Documents`

**macOS/Linux 路径：**
- 使用正斜杠 `/`
- 示例：`/Users/用户名/Documents`

**远端路径（百度网盘）：**
- 始终使用正斜杠 `/`
- 示例：`/我的文件/备份`

---

## 完整使用流程示例

```bash
# 1. 进入项目目录
cd /path/to/SyncFileToBaiDuNetEase

# 2. 设置环境（首次使用）
python3 setup_env.py

# 3. 激活虚拟环境
source venv/bin/activate  # macOS/Linux
# 或
venv\Scripts\activate.bat  # Windows

# 4. 登录（自动解析 Cookie）
python login.py

# 5. 上传文件（使用参数方式，推荐）
python upload.py --local-file /本地/文件/路径 --remote-dir /我的文件/备份

# 或使用位置参数方式
python upload.py /本地/文件/路径 /我的文件/备份

# 6. 查看上传记录
cat upload_logs/upload_log_20240120.json

# 7. 登出（可选）
python logout.py
```

---

## 注意事项

1. **Cookie 有效期**：Cookie 可能会过期，如果登录失败，需要重新获取
2. **文件覆盖**：同名文件会自动覆盖，请谨慎操作
3. **目录结构**：上传文件夹时会保持原有目录结构
4. **网络稳定**：上传大文件时建议保持网络稳定
5. **定期备份**：重要文件建议先本地备份再上传

---

## 技术支持

如果遇到问题：
1. 查看错误信息，根据提示处理
2. 检查常见问题部分
3. 确认所有步骤都正确执行

---

**祝使用愉快！** 🎉
